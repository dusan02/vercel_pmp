# üîß OPRAVI≈§ 502 BAD GATEWAY - earningstable.com (NA SERVERI)

# ============================================
# KROK 1: Skontrolova≈• PM2 procesy
# ============================================
pm2 list

# MUS√çTE VIDIE≈§:
# earnings-table    online
# earnings-cron     online

# Ak nie s√∫ online, spusti≈•:
# cd /var/www/earnings-table
# pm2 start ecosystem.config.js --only earnings-table --env production

# ============================================
# KROK 2: Skontrolova≈•, ƒçi be≈æ√≠ na porte 5555
# ============================================
ss -tlnp | grep 5555

# MUS√çTE VIDIE≈§:
# LISTEN 0.0.0.0:5555

# ============================================
# KROK 3: Test lok√°lneho servera
# ============================================
curl -v http://127.0.0.1:5555

# MUS√çTE VIDIE≈§:
# HTTP/1.1 200 OK

# ============================================
# KROK 4: N√°js≈• Nginx konfiguraƒçn√Ω s√∫bor
# ============================================
# Skontrolova≈•, ktor√Ω s√∫bor pou≈æ√≠va Nginx:
nginx -T 2>&1 | grep "configuration file"

# Skontrolova≈• sites-enabled:
ls -la /etc/nginx/sites-enabled/

# Skontrolova≈•, ƒçi existuje earningstable.com config:
cat /etc/nginx/sites-enabled/earningstable.com 2>/dev/null || echo "Config not found in sites-enabled"

# ============================================
# KROK 5: Opravi≈• Nginx konfigur√°ciu
# ============================================
# Mo≈ænos≈• A: Ak existuje /etc/nginx/sites-enabled/earningstable.com
if [ -f /etc/nginx/sites-enabled/earningstable.com ]; then
    sed -i 's|proxy_pass http://app_servers;|proxy_pass http://127.0.0.1:5555;|g' /etc/nginx/sites-enabled/earningstable.com
    sed -i 's|proxy_pass http://127.0.0.1:3000;|proxy_pass http://127.0.0.1:5555;|g' /etc/nginx/sites-enabled/earningstable.com
    echo "‚úÖ Opraven√©: /etc/nginx/sites-enabled/earningstable.com"
fi

# Mo≈ænos≈• B: Ak je v hlavnom nginx.conf
if grep -q "earningstable.com" /etc/nginx/nginx.conf; then
    sed -i 's|proxy_pass http://app_servers;|proxy_pass http://127.0.0.1:5555;|g' /etc/nginx/nginx.conf
    sed -i 's|proxy_pass http://127.0.0.1:3000;|proxy_pass http://127.0.0.1:5555;|g' /etc/nginx/nginx.conf
    echo "‚úÖ Opraven√©: /etc/nginx/nginx.conf"
fi

# Mo≈ænos≈• C: Skop√≠rova≈• opraven√Ω nginx.conf z projektu
# cd /var/www/premarketprice
# cp nginx.conf /etc/nginx/sites-available/earningstable
# ln -sf /etc/nginx/sites-available/earningstable /etc/nginx/sites-enabled/

# ============================================
# KROK 6: Overi≈• zmeny
# ============================================
grep -A 2 "proxy_pass" /etc/nginx/sites-enabled/earningstable.com 2>/dev/null | grep "5555" || \
grep -A 2 "proxy_pass" /etc/nginx/nginx.conf | grep -A 2 "earningstable" | grep "5555"

# MUS√çTE VIDIE≈§:
# proxy_pass http://127.0.0.1:5555;

# ============================================
# KROK 7: Testova≈• Nginx konfigur√°ciu
# ============================================
nginx -t

# ============================================
# KROK 8: Reload Nginx
# ============================================
systemctl reload nginx

# ============================================
# KROK 9: Skontrolova≈• Nginx error logy
# ============================================
tail -20 /var/log/nginx/error.log

# ============================================
# KROK 10: Test HTTPS
# ============================================
curl -k -I https://earningstable.com

# MUS√çTE VIDIE≈§:
# HTTP/2 200

