#!/bin/bash
# 🧪 Test API endpointu - kontrola, či sa marketCapDiff prenáša na FE

cd /var/www/premarketprice && \

echo "═══════════════════════════════════════════════════════════════════════════════" && \
echo "🧪 TEST: API Endpoint - Prenos marketCapDiff na FE" && \
echo "═══════════════════════════════════════════════════════════════════════════════" && \
echo "" && \

echo "=== TEST 1: /api/stocks?limit=5 ===" && \
echo "Kontrola, či API vracia marketCapDiff:" && \
curl -s "http://localhost:3000/api/stocks?limit=5" 2>&1 | \
  python3 -m json.tool 2>/dev/null | \
  grep -A 10 -E "(ticker|marketCapDiff|percentChange)" | head -40 || \
  echo "⚠️ API neodpovedá alebo JSON nie je validný" && \
echo "" && \

echo "=== TEST 2: Konkrétne tickery (NVDA, GOOG, MSFT) ===" && \
echo "Kontrola marketCapDiff pre veľké spoločnosti:" && \
curl -s "http://localhost:3000/api/stocks?tickers=NVDA,GOOG,MSFT,AAPL" 2>&1 | \
  python3 -m json.tool 2>/dev/null | \
  grep -B 2 -A 8 "marketCapDiff" | head -50 || \
  echo "⚠️ API neodpovedá alebo JSON nie je validný" && \
echo "" && \

echo "=== TEST 3: Kontrola HTTP status ===" && \
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000/api/stocks?limit=1") && \
echo "HTTP Status Code: $HTTP_CODE" && \
if [ "$HTTP_CODE" = "200" ]; then
  echo "✅ API odpovedá správne"
else
  echo "❌ API neodpovedá správne (status: $HTTP_CODE)"
fi && \
echo "" && \

echo "=== TEST 4: Extrahovanie marketCapDiff z API odpovede ===" && \
echo "Prvých 10 tickerov s ich marketCapDiff:" && \
curl -s "http://localhost:3000/api/stocks?limit=10" 2>&1 | \
  python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    if 'data' in data:
        for stock in data['data'][:10]:
            print(f\"{stock.get('ticker', 'N/A'):6} | marketCapDiff: {stock.get('marketCapDiff', 0):8.2f} | percentChange: {stock.get('percentChange', 0):6.2f}% | marketCap: {stock.get('marketCap', 0):8.2f}B\")
    else:
        print('⚠️ Neplatná štruktúra odpovede')
except Exception as e:
    print(f'⚠️ Chyba pri parsovaní JSON: {e}')
" 2>&1 || echo "⚠️ Python nie je dostupný alebo JSON nie je validný" && \
echo "" && \

echo "═══════════════════════════════════════════════════════════════════════════════" && \
echo "✅ TEST HOTOVÝ" && \
echo "═══════════════════════════════════════════════════════════════════════════════"

