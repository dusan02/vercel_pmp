#!/bin/bash
# 🧪 Test veľkých spoločností - kontrola výpočtu marketCapDiff

cd /var/www/premarketprice && \
DB="prisma/data/premarket.db" && \

echo "═══════════════════════════════════════════════════════════════════════════════" && \
echo "🧪 TEST: Veľké spoločnosti - Výpočet marketCapDiff" && \
echo "═══════════════════════════════════════════════════════════════════════════════" && \
echo "" && \

echo "=== TEST 1: NVDA ===" && \
sqlite3 "$DB" "SELECT 
  symbol,
  lastPrice as price,
  latestPrevClose as prevClose,
  lastChangePct as pctChange,
  lastMarketCap as marketCap,
  lastMarketCapDiff as capDiff_DB,
  sharesOutstanding as shares,
  CASE 
    WHEN sharesOutstanding > 0 THEN ROUND((lastPrice - latestPrevClose) * sharesOutstanding / 1000000000, 2)
    WHEN lastMarketCap > 0 AND lastChangePct IS NOT NULL THEN ROUND(lastMarketCap * lastChangePct / 100, 2)
    ELSE NULL
  END as capDiff_vypocitany
FROM Ticker 
WHERE symbol = 'NVDA';" 2>&1 && \
echo "" && \

echo "=== TEST 2: GOOG ===" && \
sqlite3 "$DB" "SELECT 
  symbol,
  lastPrice as price,
  latestPrevClose as prevClose,
  lastChangePct as pctChange,
  lastMarketCap as marketCap,
  lastMarketCapDiff as capDiff_DB,
  sharesOutstanding as shares,
  CASE 
    WHEN sharesOutstanding > 0 THEN ROUND((lastPrice - latestPrevClose) * sharesOutstanding / 1000000000, 2)
    WHEN lastMarketCap > 0 AND lastChangePct IS NOT NULL THEN ROUND(lastMarketCap * lastChangePct / 100, 2)
    ELSE NULL
  END as capDiff_vypocitany
FROM Ticker 
WHERE symbol = 'GOOG';" 2>&1 && \
echo "" && \

echo "=== TEST 3: MSFT ===" && \
sqlite3 "$DB" "SELECT 
  symbol,
  lastPrice as price,
  latestPrevClose as prevClose,
  lastChangePct as pctChange,
  lastMarketCap as marketCap,
  lastMarketCapDiff as capDiff_DB,
  sharesOutstanding as shares,
  CASE 
    WHEN sharesOutstanding > 0 THEN ROUND((lastPrice - latestPrevClose) * sharesOutstanding / 1000000000, 2)
    WHEN lastMarketCap > 0 AND lastChangePct IS NOT NULL THEN ROUND(lastMarketCap * lastChangePct / 100, 2)
    ELSE NULL
  END as capDiff_vypocitany
FROM Ticker 
WHERE symbol = 'MSFT';" 2>&1 && \
echo "" && \

echo "=== TEST 4: AAPL (má sharesOutstanding) ===" && \
sqlite3 "$DB" "SELECT 
  symbol,
  lastPrice as price,
  latestPrevClose as prevClose,
  lastChangePct as pctChange,
  lastMarketCap as marketCap,
  lastMarketCapDiff as capDiff_DB,
  sharesOutstanding as shares,
  CASE 
    WHEN sharesOutstanding > 0 THEN ROUND((lastPrice - latestPrevClose) * sharesOutstanding / 1000000000, 2)
    WHEN lastMarketCap > 0 AND lastChangePct IS NOT NULL THEN ROUND(lastMarketCap * lastChangePct / 100, 2)
    ELSE NULL
  END as capDiff_vypocitany
FROM Ticker 
WHERE symbol = 'AAPL';" 2>&1 && \
echo "" && \

echo "=== SÚHRN: Top 10 spoločností ===" && \
sqlite3 "$DB" "SELECT 
  symbol,
  lastPrice as price,
  latestPrevClose as prevClose,
  lastChangePct as pctChange,
  lastMarketCap as marketCap,
  lastMarketCapDiff as capDiff_DB,
  sharesOutstanding as shares,
  CASE 
    WHEN sharesOutstanding > 0 THEN '✅ Môže z price/prevClose/shares'
    WHEN lastMarketCap > 0 AND lastChangePct IS NOT NULL AND lastChangePct != 0 THEN '✅ Môže z marketCap/pctChange'
    ELSE '❌ Chýbajú dáta'
  END as moze_pocitat,
  CASE 
    WHEN sharesOutstanding > 0 THEN ROUND((lastPrice - latestPrevClose) * sharesOutstanding / 1000000000, 2)
    WHEN lastMarketCap > 0 AND lastChangePct IS NOT NULL THEN ROUND(lastMarketCap * lastChangePct / 100, 2)
    ELSE NULL
  END as capDiff_vypocitany
FROM Ticker 
WHERE lastMarketCap > 1000
ORDER BY lastMarketCap DESC 
LIMIT 10;" 2>&1 && \
echo "" && \

echo "═══════════════════════════════════════════════════════════════════════════════" && \
echo "✅ TEST HOTOVÝ" && \
echo "═══════════════════════════════════════════════════════════════════════════════"

